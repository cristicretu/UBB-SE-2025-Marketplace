@model MarketMinds.Web.Models.HomeViewModel

@{
    ViewData["Title"] = "Home Page";
    var minPrice = ViewBag.MinPrice ?? 0;
    var maxPrice = ViewBag.MaxPrice ?? 1000;
    
    // Ensure we have sensible values
    if (maxPrice <= minPrice)
    {
        maxPrice = minPrice + 100;
    }

       
    // Add user role check similar to _Layout.cshtml
    bool isAuthenticated = User.Identity?.IsAuthenticated == true && UserSession.CurrentUserId.HasValue;
    
    int userType = 0;
    if (isAuthenticated && !string.IsNullOrEmpty(UserSession.CurrentUserRole))
    {
        if (int.TryParse(UserSession.CurrentUserRole, out int parsedType))
        {
            userType = parsedType;
        }
        else
        {
            switch (UserSession.CurrentUserRole)
            {
                case "Admin": userType = 1; break;
                case "Buyer": userType = 2; break;
                case "Seller": userType = 3; break;
                default: userType = 0; break;
            }
        }
    }
    
    bool isAdmin = isAuthenticated && userType == 1;
    bool isBuyer = isAuthenticated && userType == 2;
    bool isSeller = isAuthenticated && userType == 3;
    
    // Check if user can make purchases (admins and buyers)
    bool canPurchase = isAdmin || isBuyer;
}

<div class="flex flex-col md:flex-row">
    <!-- Sidebar with filters (collapsible) -->
    <div id="filterSidebar" class="w-full md:w-72 bg-white p-5 rounded-lg shadow-sm md:mr-5 mb-5 md:mb-0 border border-gray-200">
        <div class="flex justify-between items-center mb-5">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                <i class="fas fa-filter mr-2 text-gray-600"></i>
                Filters
            </h3>
            <button id="toggleFilters" class="md:hidden text-gray-500 hover:text-gray-700">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        
        <div id="filterContent" class="filter-content">
            <!-- Search bar -->
            <div class="mb-5">
                <div class="relative">
                    <input type="text" id="searchInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition" placeholder="Search products...">
                    <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <hr class="my-4 border-t border-gray-200" />
            
            <!-- Price Range -->
            <div class="mb-5">
                <h4 class="font-medium mb-3 text-gray-700">Price Range</h4>
                <div class="space-y-3">
                    <div>
                        <input type="range" id="priceRange" class="w-full accent-primary" min="@minPrice" max="@maxPrice" step="1" value="@maxPrice">
                        <div class="flex justify-between text-sm text-gray-600 mt-1">
                            <span class="font-mono opacity-50">$<span id="minPriceValue">@minPrice</span></span>
                            <span class="font-mono">$<span id="currentPriceValue">@maxPrice</span></span>
                            <span class="font-mono opacity-50">$<span id="maxPriceValue">@maxPrice</span></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <hr class="my-4 border-t border-gray-200" />
            
            <!-- Categories -->
            <div class="mb-5">
                <h4 class="font-medium mb-3 text-gray-700">Categories</h4>
                <div class="flex flex-wrap gap-2 max-h-48 overflow-y-auto pr-1">
                    @if (ViewBag.Categories != null)
                    {
                        @foreach (var category in ViewBag.Categories)
                        {
                            <button class="category-pill px-3 py-1 rounded-full bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200 text-sm transition-colors" 
                                    data-category-id="@category.Id">
                                @category.Name
                            </button>
                        }
                    }
                    else
                    {
                        <span class="text-gray-500">No categories available</span>
                    }
                </div>
            </div>
            
            <hr class="my-4 border-t border-gray-200" />
            
            <!-- Conditions -->
            <div class="mb-5">
                <h4 class="font-medium mb-3 text-gray-700">Condition</h4>
                <div class="flex flex-wrap gap-2">
                    @if (ViewBag.Conditions != null)
                    {
                        @foreach (var condition in ViewBag.Conditions)
                        {
                            <button class="condition-pill px-3 py-1 rounded-full bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200 text-sm transition-colors" 
                                    data-condition-id="@condition.Id">
                                @condition.Name
                            </button>
                        }
                    }
                    else
                    {
                        <span class="text-gray-500">No conditions available</span>
                    }
                </div>
            </div>
            
            <hr class="my-4 border-t border-gray-200" />
            
            <!-- if there are any filters applied, show the clear filters button -->
            <button id="clearFilters" class="w-full bg-gray-100 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-200 transition mb-2 border border-gray-300 opacity-50 cursor-not-allowed" disabled>
                <i class="fas fa-times mr-2"></i>Clear Filters
            </button>
        </div>
    </div>

    <!-- Main content area -->
    <div class="flex-1">
        <!-- Product Type Tabs -->
        <div class="mb-6">
            <div class="flex gap-3">
                <button id="buyTab" class="tab-btn active py-2 px-4 rounded-lg font-medium text-white bg-primary border border-primary shadow-sm hover:shadow-md transition-all flex items-center">
                    <i class="fas fa-shopping-bag mr-2"></i>
                    Buy Products
                </button>
                <button id="auctionTab" class="tab-btn py-2 px-4 rounded-lg font-medium text-gray-700 bg-white border border-gray-300 shadow-sm hover:shadow-md transition-all flex items-center">
                    <i class="fas fa-gavel mr-2"></i>
                    Auction Products
                </button>
                <button id="borrowTab" class="tab-btn py-2 px-4 rounded-lg font-medium text-gray-700 bg-white border border-gray-300 shadow-sm hover:shadow-md transition-all flex items-center">
                    <i class="fas fa-calendar-alt mr-2"></i>
                    Borrow Products
                </button>
            </div>
            
            <hr class="mt-4 mb-6 border-t border-gray-200" />
        </div>
        
        <!-- Products Grid - Buy Products (default view) -->
        <div id="buyProducts" class="tab-content">
            <div id="buyProductsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                @foreach (var item in Model.BuyProducts)
                {
                    <div class="product-item bg-white rounded-lg shadow-sm overflow-hidden transition-transform hover:shadow-md border border-gray-200"
                         data-price="@item.Price" 
                         data-category="@(item.Category?.Id ?? 0)" 
                         data-condition="@(item.Condition?.Id ?? 0)"
                         data-title="@item.Title.ToLower()"
                         data-seller="@(item.Seller?.Username?.ToLower() ?? "")">
                        <a href="@Url.Action("Details", "BuyProducts", new { id = item.Id })" class="block">
                            <div class="h-48 bg-gradient-to-r from-blue-50 to-blue-100 flex items-center justify-center">
                                @if (item.Images != null && item.Images.Any())
                                {
                                    <img src="@item.Images.First().Url" alt="@item.Title" class="h-full w-full object-cover">
                                }
                                else
                                {
                                    <div class="text-gray-400 text-lg">No Image</div>
                                }
                            </div>
                            <div class="p-4">
                                <div class="">
                                    <h3 class="font-semibold text-lg mb-1 truncate">@item.Title</h3>
                                    <p class="text-sm text-gray-500 mb-1">
                                        @if (item.Category != null)
                                        {
                                            <span>@(item.Category.Name ?? "Uncategorized")</span>
                                        }
                                        else
                                        {
                                            <span>Uncategorized</span>
                                        }
                                        â€¢
                                        @if (item.Condition != null)
                                        {
                                            <span>@(item.Condition.Name ?? "Unknown condition")</span>
                                        }
                                        else
                                        {
                                            <span>Unknown condition</span>
                                        }
                                    </p>
                                    <p class="text-sm text-gray-500 mb-2">
                                        @if (item.Seller != null)
                                        {
                                            <span>Seller: @item.Seller.Username</span>
                                        }
                                        else
                                        {
                                            <span>Unknown seller</span>
                                        }
                                    </p>
                                    <div class="flex justify-between items-center">
                                        <div class="font-bold text-primary">$@item.Price.ToString("N2")</div>
                                        @if (isBuyer)
                                        {
                                            var isInWishlist = ViewBag.WishlistProductIds != null && ((List<int>)ViewBag.WishlistProductIds).Contains(item.Id);
                                            
                                            if (isInWishlist)
                                            {
                                                <form asp-controller="BuyerWishlist" asp-action="RemoveFromWishlist" method="post" class="inline">
                                                    <input type="hidden" name="productId" value="@item.Id" />
                                                    <button type="submit" class="text-red-500 hover:text-red-600 transition" 
                                                            title="Remove from Wishlist" onclick="event.stopPropagation();">
                                                        <i class="fas fa-heart"></i>
                                                    </button>
                                                </form>
                                            }
                                            else
                                            {
                                                <form asp-controller="BuyerWishlist" asp-action="AddToWishlist" method="post" class="inline">
                                                    <input type="hidden" name="productId" value="@item.Id" />
                                                    <button type="submit" class="text-gray-400 hover:text-red-500 transition" 
                                                            title="Add to Wishlist" onclick="event.stopPropagation();">
                                                        <i class="far fa-heart"></i>
                                                    </button>
                                                </form>
                                            }
                                        }
                                    </div>
                                </div>
                            </div>
                        </a>
                        <div class="px-4 pb-4">
                            @if (User.Identity.IsAuthenticated && canPurchase)
                            {
                                <form asp-controller="ShoppingCart" asp-action="AddToCart" method="post">
                                    <input type="hidden" name="productId" value="@item.Id" />
                                    <input type="hidden" name="quantity" value="1" />
                                    <button type="submit" class="w-full bg-primary text-white py-2 px-3 rounded-lg hover:bg-primary-dark transition flex items-center justify-center">
                                        <i class="fas fa-shopping-cart mr-2"></i>
                                        Add to Cart
                                    </button>
                                </form>
                            }
                            else if (isSeller)
                            {
                            }
                            else
                            {
                                <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path" class="w-full bg-primary text-white py-2 px-3 rounded-lg hover:bg-primary-dark transition flex items-center justify-center inline-block text-center">
                                    <i class="fas fa-shopping-cart mr-2"></i>
                                    Add to Cart
                                </a>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
        
        <!-- Products Grid - Auction Products (hidden initially) -->
        <div id="auctionProducts" class="tab-content hidden">
            <div id="auctionProductsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                @foreach (var item in Model.AuctionProducts)
                {
                    <div class="product-item bg-white rounded-lg shadow-sm overflow-hidden transition-transform hover:shadow-md border border-gray-200"
                         data-price="@item.CurrentPrice" 
                         data-category="@(item.Category?.Id ?? 0)" 
                         data-condition="@(item.Condition?.Id ?? 0)"
                         data-title="@item.Title.ToLower()"
                         data-seller="@(item.Seller?.Username?.ToLower() ?? "")">
                        <a href="@Url.Action("Details", "AuctionProducts", new { id = item.Id })" class="block">
                            <div class="h-48 bg-gradient-to-r from-purple-50 to-blue-50 flex items-center justify-center">
                                @if (item.Images != null && item.Images.Any())
                                {
                                    <img src="@item.Images.First().Url" alt="@item.Title" class="h-full w-full object-cover">
                                }
                                else
                                {
                                    <div class="text-gray-400 text-lg">No Image</div>
                                }
                            </div>
                            <div class="p-4">
                                <h2 class="text-xl font-semibold">@item.Title</h2>
                                <p class="text-gray-600 mb-1">@(item.Category?.Name ?? "Uncategorized")</p>
                                
                                @if (!string.IsNullOrEmpty(item.Description) && item.Description.Length > 50)
                                {
                                    <p class="text-gray-700 text-sm mb-3">@(item.Description.Substring(0, 50))...</p>
                                }
                                else
                                {
                                    <p class="text-gray-700 text-sm mb-3">@(item.Description ?? "No description")</p>
                                }
                                
                                <div class="flex justify-between items-center mb-3">
                                    <span class="text-primary font-bold text-xl">$@item.CurrentPrice.ToString("N2")</span>
                                    <span class="text-gray-600 text-sm">Starting: $@item.StartPrice.ToString("N2")</span>
                                </div>
                                
                                <div class="text-orange-600 font-medium mb-3" data-countdown="@item.EndTime.ToString("yyyy-MM-ddTHH:mm:ss")">
                                    Time left: 
                                    @{
                                        var timeLeft = item.EndTime - DateTime.Now;
                                        if (timeLeft > TimeSpan.Zero)
                                        {
                                            @($"{timeLeft.Days}d {timeLeft.Hours}h {timeLeft.Minutes}m")
                                        }
                                        else
                                        {
                                            <span class="text-red-600">Auction Ended</span>
                                        }
                                    }
                                </div>
                            </div>
                        </a>
                        <div class="px-4 pb-4">
                            @if (User.Identity.IsAuthenticated && canPurchase)
                            {
                                <form asp-controller="AuctionProducts" asp-action="PlaceBid" method="post">
                                    <input type="hidden" name="productId" value="@item.Id" />
                                    <button type="submit" class="w-full bg-purple-600 text-white py-2 px-3 rounded-lg hover:bg-purple-700 transition flex items-center justify-center">
                                        <i class="fas fa-gavel mr-2"></i>
                                        Place Bid
                                    </button>
                                </form>
                            }
                            else if (isSeller)
                            {
                            }
                            else
                            {
                                <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path" class="w-full bg-purple-600 text-white py-2 px-3 rounded-lg hover:bg-purple-700 transition flex items-center justify-center inline-block text-center">
                                    <i class="fas fa-gavel mr-2"></i>
                                    Place Bid
                                </a>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
        
        <!-- Products Grid - Borrow Products (hidden initially) -->
        <div id="borrowProducts" class="tab-content hidden">
            <div id="borrowProductsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                @foreach (var item in Model.BorrowProducts)
                {
                    <div class="product-item bg-white rounded-lg shadow-sm overflow-hidden transition-transform hover:shadow-md border border-gray-200"
                         data-price="@item.DailyRate" 
                         data-category="@(item.Category?.Id ?? 0)" 
                         data-condition="@(item.Condition?.Id ?? 0)"
                         data-title="@item.Title.ToLower()"
                         data-seller="@(item.Seller?.Username?.ToLower() ?? "")">
                        <a href="@Url.Action("Details", "BorrowProducts", new { id = item.Id })" class="block">
                            <div class="h-48 bg-gradient-to-r from-green-50 to-purple-50 flex items-center justify-center">
                                @if (item.Images != null && item.Images.Any())
                                {
                                    <img src="@item.Images.First().Url" alt="@item.Title" class="h-full w-full object-cover">
                                }
                                else
                                {
                                    <div class="text-gray-400 text-lg">No Image</div>
                                }
                            </div>
                            <div class="p-4">
                                <h2 class="text-xl font-semibold">@item.Title</h2>
                                <p class="text-gray-600 mb-1">@(item.Category?.Name ?? "Uncategorized")</p>
                                
                                @if (!string.IsNullOrEmpty(item.Description) && item.Description.Length > 50)
                                {
                                    <p class="text-gray-700 text-sm mb-3">@(item.Description.Substring(0, 50))...</p>
                                }
                                else
                                {
                                    <p class="text-gray-700 text-sm mb-3">@(item.Description ?? "No description")</p>
                                }
                                
                                <div class="flex justify-between items-center mb-3">
                                    <span class="text-green-600 font-bold text-xl">$@item.DailyRate.ToString("N2")</span>
                                    <span class="text-gray-600 text-sm">Per Day</span>
                                </div>
                                
                                <div class="text-orange-600 font-medium mb-3">
                                    Status: 
                                    @if (item.IsBorrowed)
                                    {
                                        <span class="text-red-600">Currently Borrowed</span>
                                    }
                                    else
                                    {
                                        <span class="text-green-600">Available</span>
                                    }
                                </div>
                                
                                <div class="text-gray-600 font-medium mb-3">
                                    @{
                                        var availability = "";
                                        if (item.StartDate.HasValue && item.EndDate.HasValue)
                                        {
                                            availability = $"Available: {item.StartDate.Value.ToShortDateString()} - {item.EndDate.Value.ToShortDateString()}";
                                        }
                                        else if (item.EndDate.HasValue)
                                        {
                                            availability = $"Available until: {item.EndDate.Value.ToShortDateString()}";
                                        }
                                        else
                                        {
                                            availability = "No availability information";
                                        }
                                    }
                                    @availability
                                </div>
                            </div>
                        </a>
                        <div class="px-4 pb-4">
                            @if (User.Identity.IsAuthenticated && canPurchase)
                            {
                                <button class="w-full bg-green-600 text-white py-2 px-3 rounded-lg hover:bg-green-700 transition flex items-center justify-center">
                                    <i class="fas fa-calendar-alt mr-2"></i>
                                    Rent Now
                                </button>
                            }
                            else if (isSeller)
                            {
                            }
                            else
                            {
                                <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path" class="w-full bg-green-600 text-white py-2 px-3 rounded-lg hover:bg-green-700 transition flex items-center justify-center inline-block text-center">
                                    <i class="fas fa-calendar-alt mr-2"></i>
                                    Rent Now
                                </a>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
        
        <!-- Pagination Controls -->
        @if (ViewBag.TotalProducts != null && (int)ViewBag.TotalProducts > 0)
        {
            <div id="paginationContainer" class="mt-8 bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <!-- Pagination Info (left side) -->
                    <div id="paginationInfo" class="text-sm text-gray-600 order-1 sm:order-none">
                        @{
                            int currentOffset = ViewBag.CurrentOffset ?? 0;
                            int currentCount = ViewBag.CurrentCount ?? 12;
                            int totalProducts = ViewBag.TotalProducts ?? 0;
                            int startItem = totalProducts > 0 ? currentOffset + 1 : 0;
                            int endItem = Math.Min(currentOffset + currentCount, totalProducts);
                        }
                        Showing @startItem to @endItem of @totalProducts products
                    </div>
                    
                    <!-- Pagination Navigation (center) -->
                    <div id="paginationNav" class="flex items-center gap-2 order-2 sm:order-none mx-auto">
                        @{
                            int currentPage = currentCount > 0 ? (currentOffset / currentCount) + 1 : 1;
                            int totalPages = currentCount > 0 ? (int)Math.Ceiling((double)totalProducts / currentCount) : 1;
                            string currentTab = ViewBag.CurrentTab ?? "buy";
                        }
                        
                        <!-- Previous Button -->
                        @if (currentPage > 1)
                        {
                            <a href="@Url.Action("Index", new { offset = Math.Max(0, currentOffset - currentCount), count = currentCount, tab = currentTab })" 
                               class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 transition-colors">
                                Previous
                            </a>
                        }
                        else
                        {
                            <span class="px-3 py-2 text-sm font-medium text-gray-300 bg-gray-100 border border-gray-200 rounded-md cursor-not-allowed">
                                Previous
                            </span>
                        }
                        
                        <!-- Page Numbers -->
                        @for (int pageNum = 1; pageNum <= Math.Min(totalPages, 5); pageNum++)
                        {
                            int pageOffset = (pageNum - 1) * currentCount;
                            if (pageNum == currentPage)
                            {
                                <span class="px-3 py-2 text-sm font-medium text-white bg-primary border border-primary rounded-md">
                                    @pageNum
                                </span>
                            }
                            else
                            {
                                <a href="@Url.Action("Index", new { offset = pageOffset, count = currentCount, tab = currentTab })" 
                                   class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 transition-colors">
                                    @pageNum
                                </a>
                            }
                        }
                        
                        @if (totalPages > 5)
                        {
                            <span class="px-2 py-2 text-sm text-gray-500">...</span>
                            int lastPageOffset = (totalPages - 1) * currentCount;
                            <a href="@Url.Action("Index", new { offset = lastPageOffset, count = currentCount, tab = currentTab })" 
                               class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 transition-colors">
                                @totalPages
                            </a>
                        }
                        
                        <!-- Next Button -->
                        @if (currentPage < totalPages)
                        {
                            <a href="@Url.Action("Index", new { offset = currentOffset + currentCount, count = currentCount, tab = currentTab })" 
                               class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 transition-colors">
                                Next
                            </a>
                        }
                        else
                        {
                            <span class="px-3 py-2 text-sm font-medium text-gray-300 bg-gray-100 border border-gray-200 rounded-md cursor-not-allowed">
                                Next
                            </span>
                        }
                    </div>
                    
                    <!-- Empty space for balance (right side) -->
                    <div class="hidden sm:block w-32"></div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get current tab from ViewBag
            const currentTab = '@ViewBag.CurrentTab' || 'buy';
            
            // Initialize price range slider immediately
            const priceRange = document.getElementById('priceRange');
            const currentPriceValue = document.getElementById('currentPriceValue');
            const minPriceValue = document.getElementById('minPriceValue');
            const maxPriceValue = document.getElementById('maxPriceValue');
            
            if (priceRange) {
                // Make sure the slider is at maximum by default
                priceRange.value = priceRange.max;
                
                // Update display values
                if (currentPriceValue) {
                    currentPriceValue.textContent = priceRange.max;
                }
                if (minPriceValue) {
                    minPriceValue.textContent = priceRange.min;
                }
                if (maxPriceValue) {
                    maxPriceValue.textContent = priceRange.max;
                }
                
                // Add event listener for price range changes
                priceRange.addEventListener('input', function() {
                    if (currentPriceValue) {
                        currentPriceValue.textContent = this.value;
                    }
                    applyFilters();
                });
            }
            
            // Tab functionality
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Set initial active tab based on current tab parameter
            function setActiveTab(tabName) {
                // Deactivate all tabs
                tabButtons.forEach(btn => {
                    btn.classList.remove('active', 'text-white');
                    btn.classList.add('text-gray-700', 'bg-white', 'border-gray-300');
                    btn.classList.remove('bg-primary', 'bg-purple-600', 'bg-green-600', 'border-primary', 'border-purple-600', 'border-green-600');
                });
                
                // Hide all content
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Activate the specified tab
                const targetTab = document.getElementById(tabName + 'Tab');
                if (targetTab) {
                    targetTab.classList.add('active', 'text-white');
                    targetTab.classList.remove('text-gray-700', 'bg-white', 'border-gray-300');
                    
                    if (tabName === 'buy') {
                        targetTab.classList.add('bg-primary', 'border-primary');
                    } else if (tabName === 'auction') {
                        targetTab.classList.add('bg-purple-600', 'border-purple-600');
                    } else if (tabName === 'borrow') {
                        targetTab.classList.add('bg-green-600', 'border-green-600');
                    }
                    
                    // Show corresponding content
                    const contentId = tabName + 'Products';
                    const content = document.getElementById(contentId);
                    if (content) {
                        content.classList.remove('hidden');
                    }
                }
            }
            
            // Set initial tab
            setActiveTab(currentTab);
            
            // Tab switching with server-side navigation
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.id.replace('Tab', '');
                    
                    // Navigate to the new tab with server-side pagination (reset to page 1)
                    window.location.href = '@Url.Action("Index")?offset=0&count=12&tab=' + tabName;
                });
            });
            
            // Mobile filter toggle
            const toggleFiltersBtn = document.getElementById('toggleFilters');
            const filterContent = document.getElementById('filterContent');
            
            if (toggleFiltersBtn && filterContent) {
                toggleFiltersBtn.addEventListener('click', function() {
                    filterContent.classList.toggle('hidden');
                    const icon = this.querySelector('i');
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                });
                
                // Show filters by default on desktop, hide on mobile
                function handleResize() {
                    if (window.innerWidth < 768) {
                        filterContent.classList.add('hidden');
                    } else {
                        filterContent.classList.remove('hidden');
                    }
                }
                
                // Initial check and event listener for resize
                handleResize();
                window.addEventListener('resize', handleResize);
            }
            
            // Filter functionality (client-side filtering of current page results)
            const searchInput = document.getElementById('searchInput');
            const categoryPills = document.querySelectorAll('.category-pill');
            const conditionPills = document.querySelectorAll('.condition-pill');
            
            // Search functionality
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    applyFilters();
                });
            }
            
            // Category filters
            if (categoryPills && categoryPills.length > 0) {
                categoryPills.forEach(pill => {
                    pill.addEventListener('click', function() {
                        // Toggle active state
                        this.classList.toggle('bg-primary');
                        this.classList.toggle('text-white');
                        this.classList.toggle('border-primary');
                        this.classList.toggle('bg-gray-100');
                        this.classList.toggle('text-gray-700');
                        this.classList.toggle('border-gray-200');
                        
                        applyFilters();
                    });
                });
            }
            
            // Condition filters
            if (conditionPills && conditionPills.length > 0) {
                conditionPills.forEach(pill => {
                    pill.addEventListener('click', function() {
                        // Toggle active state
                        this.classList.toggle('bg-primary');
                        this.classList.toggle('text-white');
                        this.classList.toggle('border-primary');
                        this.classList.toggle('bg-gray-100');
                        this.classList.toggle('text-gray-700');
                        this.classList.toggle('border-gray-200');
                        
                        applyFilters();
                    });
                });
            }
            
            // Clear filters
            const clearFiltersBtn = document.getElementById('clearFilters');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', function() {
                    // Reset search
                    if (searchInput) searchInput.value = '';
                    
                    // Reset price range
                    if (priceRange) {
                        priceRange.value = priceRange.max;
                        currentPriceValue.textContent = priceRange.max;
                    }
                    
                    // Reset all category pills
                    categoryPills.forEach(pill => {
                        pill.classList.remove('bg-primary', 'text-white', 'border-primary');
                        pill.classList.add('bg-gray-100', 'text-gray-700', 'border-gray-200');
                    });
                    
                    // Reset all condition pills
                    conditionPills.forEach(pill => {
                        pill.classList.remove('bg-primary', 'text-white', 'border-primary');
                        pill.classList.add('bg-gray-100', 'text-gray-700', 'border-gray-200');
                    });
                    
                    // Apply filters (show all)
                    applyFilters();
                });
            }
            
            // Apply client-side filters to current page results only
            function applyFilters() {
                try {
                    const activeTab = document.querySelector('.tab-btn.active');
                    if (!activeTab) return;
                    
                    const tabName = activeTab.id.replace('Tab', '');
                    const gridId = tabName + 'ProductsGrid';
                    const grid = document.getElementById(gridId);
                    if (!grid) return;
                    
                    const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                    const maxPrice = priceRange ? parseFloat(priceRange.value) : Infinity;
                    
                    // Get selected categories
                    const selectedCategories = Array.from(categoryPills)
                        .filter(pill => pill.classList.contains('bg-primary'))
                        .map(pill => pill.getAttribute('data-category-id'));
                    
                    // Get selected conditions
                    const selectedConditions = Array.from(conditionPills)
                        .filter(pill => pill.classList.contains('bg-primary'))
                        .map(pill => pill.getAttribute('data-condition-id'));
                    
                    // Filter products
                    const products = grid.querySelectorAll('.product-item');
                    let visibleCount = 0;
                    let hasActiveFilters = false;
                    
                    // Check if any filters are active
                    if (searchTerm || maxPrice < parseFloat(priceRange.max) || selectedCategories.length > 0 || selectedConditions.length > 0) {
                        hasActiveFilters = true;
                    }
                    
                    products.forEach(product => {
                        const title = product.getAttribute('data-title') || '';
                        const seller = product.getAttribute('data-seller') || '';
                        const price = parseFloat(product.getAttribute('data-price')) || 0;
                        const category = product.getAttribute('data-category') || '';
                        const condition = product.getAttribute('data-condition') || '';
                        
                        let show = true;
                        
                        // Search filter
                        if (searchTerm && !title.includes(searchTerm) && !seller.includes(searchTerm)) {
                            show = false;
                        }
                        
                        // Price filter
                        if (price > maxPrice) {
                            show = false;
                        }
                        
                        // Category filter
                        if (selectedCategories.length > 0 && !selectedCategories.includes(category)) {
                            show = false;
                        }
                        
                        // Condition filter
                        if (selectedConditions.length > 0 && !selectedConditions.includes(condition)) {
                            show = false;
                        }
                        
                        if (show) {
                            product.style.display = 'block';
                            visibleCount++;
                        } else {
                            product.style.display = 'none';
                        }
                    });
                    
                    // Update clear filters button state
                    if (clearFiltersBtn) {
                        if (hasActiveFilters) {
                            clearFiltersBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                            clearFiltersBtn.disabled = false;
                        } else {
                            clearFiltersBtn.classList.add('opacity-50', 'cursor-not-allowed');
                            clearFiltersBtn.disabled = true;
                        }
                    }
                    
                } catch (error) {
                    console.error('Error applying filters:', error);
                }
            }
            
            // Initial filter application
            applyFilters();
        });
    </script>
}

<style>
    .pb-3\/4 {
        padding-bottom: 75%;
    }
    
    /* Custom styling for range slider */
    input[type=range] {
        height: 6px;
        border-radius: 5px;
    }
    
    input[type=range]::-webkit-slider-thumb {
        height: 16px;
        width: 16px;
        border-radius: 50%;
    }
</style> 